# THIS CONFIG IS FOR USE WITH Beacon & Mellow SB2040

# Required Configs, Always include these
[include mainsail.cfg]
[include macros/*.cfg]
# [include scripts/*.cfg]
[include timelapse.cfg]
[include K-ShakeTune/*.cfg]

#####################################################################
#   MCU / Octopus v1.1 / SB2040
#####################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_25002D000150335331383520-if00
#serial: platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.3:1.0
restart_method: command

[mcu SB2040]
canbus_uuid: 1b89fd606a4c

[temperature_sensor Octopus]
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 0
max_temp: 100

[temperature_sensor SB2040]
sensor_type: temperature_mcu
sensor_mcu: SB2040
min_temp: 0
max_temp: 100

[temperature_sensor RPi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100


#####################################################################
#   Machine
#####################################################################

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 10000
max_z_velocity: 15
max_z_accel: 350
square_corner_velocity: 5.0

[idle_timeout]
timeout: 1800


#####################################################################
#   X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: SB2040:gpio29
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 75
homing_retract_dist: 5

[tmc2209 stepper_x]
uart_pin: PC4
interpolate: False
run_current: 0.9
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: PG9
position_min: 0
position_endstop: 307
position_max: 307
homing_speed: 75
homing_retract_dist: 5

[tmc2209 stepper_y]
uart_pin: PD11
interpolate: False
run_current: 0.9
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Z Stepper Settings
#####################################################################

[stepper_z]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_max: 290
position_min: -2.5
homing_speed: 10
second_homing_speed: 3
homing_retract_dist: 0


[tmc2209 stepper_z]
uart_pin: PC6
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z2]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Extruder / CW2
#####################################################################

[extruder]
step_pin: SB2040:gpio9
dir_pin: !SB2040:gpio10
enable_pin: !SB2040:gpio7
rotation_distance: 22.6789511
gear_ratio: 50:10
microsteps: 32
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: SB2040:gpio6
sensor_pin: SB2040:gpio27
sensor_type: ATC Semitec 104NT-4-R025H42G
min_temp: 10
max_temp: 315
max_extrude_only_distance: 500
max_extrude_cross_section: 5.0
max_power: 1.0
min_extrude_temp: 170
pressure_advance: 0.02
pressure_advance_smooth_time: 0.020

[tmc2209 extruder]
uart_pin: SB2040:gpio8
interpolate: false
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[firmware_retraction]
retract_length: 0.8
retract_speed: 30
unretract_extra_length: 0.0
unretract_speed: 30


#####################################################################
#   ADXL / Input Shaper
#####################################################################

[adxl345]
cs_pin: SB2040:gpio1
spi_software_sclk_pin: SB2040:gpio0
spi_software_mosi_pin: SB2040:gpio3
spi_software_miso_pin: SB2040:gpio2
axes_map: x,y,z

[resonance_tester]
accel_per_hz: 75
accel_chip: adxl345
probe_points: 150, 150, 20

[input_shaper]
shaper_type_x = zv
shaper_freq_x = 67.8
shaper_type_y = mzv
shaper_freq_y = 45.6


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA2
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
max_power: 1
pwm_cycle_time: 0.0166
min_temp: 0
max_temp: 120


#####################################################################
#   Beacon
#####################################################################

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_8E79821B4E4B333448202020FF0A1818-if00
x_offset: 0
y_offset: 17.5
mesh_main_direction: x
mesh_runs: 2


#####################################################################
#   Bed Mesh
#####################################################################

[bed_mesh]
speed: 450
mesh_min: 30,30
mesh_max: 270,270
probe_count: 25,25
algorithm: bicubic


#####################################################################
#   Z-Tilt
#####################################################################

[z_tilt]
z_positions:
   -50, 18
   150, 348
   350, 18
points:
   30, 12.5
   150, 252.5
   270, 12.5
speed: 450
retries: 10
retry_tolerance: 0.004
horizontal_move_z: 10


#####################################################################
#   Safe Home
#####################################################################

[safe_z_home]
home_xy_position: 150,150
speed: 500
z_hop: 10


#####################################################################
#   Fan Control
#####################################################################

[fan]
pin: SB2040:gpio13
kick_start_time: 0.5
off_below: 0.10

[heater_fan hotend_fan]
pin: SB2040:gpio14
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[controller_fan Controller_Fan]
pin: PD12
kick_start_time: 0.5
fan_speed: 0.50
idle_timeout: 1800

[controller_fan SB2040_Fan]
pin: SB2040:gpio15
kick_start_time: 0.5
heater: heater_bed
fan_speed: 1.0


#####################################################################
# 	Chamber Thermistor
#####################################################################

[temperature_sensor Chamber]
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF5
min_temp: 0
max_temp: 100
gcode_id: chamber_th

[temperature_sensor Tool_Head]
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: SB2040:gpio26
min_temp: 0
max_temp: 100


#####################################################################
# EXP1 / EXP2 (display) pins
#####################################################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>


#####################################################################
#   Displays
#####################################################################

[display]
lcd_type: uc1701
cs_pin: EXP1_3
a0_pin: EXP1_4
rst_pin: EXP1_5
encoder_pins: ^EXP2_5, ^EXP2_3
click_pin: ^!EXP1_2
contrast: 63
spi_software_miso_pin: EXP2_1
spi_software_mosi_pin: EXP2_6
spi_software_sclk_pin: EXP2_2

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.865
#*# pid_ki = 4.335
#*# pid_kd = 58.553
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 65.636
#*# pid_ki = 4.376
#*# pid_kd = 246.136
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.017914, 0.015506, 0.019685, 0.014152, 0.007764, 0.004024, 0.002024, 0.003019, 0.008209, 0.017483, 0.012123, -0.003053, -0.000144, 0.005847, 0.018621, 0.028891, 0.030146, 0.033843, 0.033244, 0.034740, 0.039890, 0.033393, 0.030545, 0.024248, 0.016107
#*# 	0.017698, 0.016360, 0.020106, 0.011663, 0.001854, -0.001864, -0.004425, -0.003525, 0.004177, 0.011709, 0.005774, -0.011329, -0.009190, -0.002163, 0.012025, 0.025914, 0.023657, 0.028011, 0.024870, 0.027716, 0.031393, 0.026614, 0.022491, 0.015594, 0.008569
#*# 	0.017691, 0.012275, 0.021464, 0.004628, -0.004343, -0.010140, -0.012563, -0.010010, -0.003636, 0.004538, -0.000990, -0.017344, -0.016823, -0.010792, 0.002202, 0.016913, 0.016089, 0.020630, 0.020022, 0.020131, 0.023720, 0.016658, 0.016616, 0.007526, 0.002519
#*# 	0.012706, 0.003621, 0.020758, 0.000576, -0.011776, -0.017402, -0.021851, -0.018433, -0.010301, -0.000847, -0.006838, -0.025228, -0.024980, -0.021551, -0.007061, 0.012476, 0.009549, 0.014085, 0.012909, 0.012294, 0.016594, 0.009955, 0.010379, 0.000293, -0.006124
#*# 	0.003644, -0.004080, 0.015712, -0.008095, -0.021173, -0.027210, -0.031853, -0.029147, -0.020573, -0.011662, -0.018199, -0.041153, -0.043750, -0.036862, -0.018880, 0.002855, -0.001465, 0.001805, 0.002405, 0.002907, 0.006487, 0.002681, 0.000737, -0.010926, -0.015670
#*# 	-0.005211, -0.011284, 0.013438, -0.010243, -0.025010, -0.033428, -0.038859, -0.037958, -0.029813, -0.020468, -0.030944, -0.056404, -0.060791, -0.054429, -0.033018, -0.007285, -0.010207, -0.007076, -0.010449, -0.008221, -0.004557, -0.006880, -0.007737, -0.017721, -0.026075
#*# 	-0.008933, -0.014454, 0.012139, -0.010106, -0.023165, -0.032009, -0.039063, -0.035893, -0.032620, -0.023364, -0.034664, -0.060801, -0.064582, -0.057440, -0.036393, -0.015187, -0.017243, -0.015755, -0.017323, -0.016240, -0.008676, -0.014002, -0.015300, -0.025698, -0.032090
#*# 	-0.008520, -0.010833, 0.001614, -0.006053, -0.018813, -0.025128, -0.032681, -0.034366, -0.029732, -0.021385, -0.027966, -0.048477, -0.048674, -0.046134, -0.029073, -0.017671, -0.017734, -0.018461, -0.021485, -0.018222, -0.013772, -0.016890, -0.017023, -0.024745, -0.032045
#*# 	-0.003485, -0.010274, -0.005564, -0.004870, -0.012747, -0.016745, -0.024234, -0.025752, -0.021048, -0.012503, -0.018087, -0.035260, -0.032060, -0.030010, -0.021937, -0.013820, -0.016430, -0.017706, -0.019920, -0.017622, -0.010855, -0.016003, -0.015572, -0.021742, -0.033147
#*# 	-0.004733, -0.009333, -0.006348, -0.006630, -0.014234, -0.018835, -0.025051, -0.027016, -0.022525, -0.013047, -0.017867, -0.030652, -0.029608, -0.027196, -0.023193, -0.017289, -0.021438, -0.022799, -0.026222, -0.022383, -0.015454, -0.019997, -0.024073, -0.033696, -0.037302
#*# 	0.000131, -0.006589, -0.001904, -0.001961, -0.008495, -0.017078, -0.024014, -0.025717, -0.020394, -0.011990, -0.014429, -0.026394, -0.027124, -0.026241, -0.021380, -0.016214, -0.020180, -0.022451, -0.026038, -0.024437, -0.016776, -0.022187, -0.027448, -0.034924, -0.033820
#*# 	0.010273, 0.004162, 0.008245, 0.007462, -0.001813, -0.009169, -0.018646, -0.018767, -0.014092, -0.005820, -0.008785, -0.021215, -0.020136, -0.018242, -0.013840, -0.011590, -0.016879, -0.020415, -0.025717, -0.022961, -0.014159, -0.020948, -0.025953, -0.033647, -0.018092
#*# 	0.029321, 0.021310, 0.024223, 0.023660, 0.014155, 0.004526, -0.002621, -0.006434, -0.001778, 0.007414, 0.005209, -0.008744, -0.007965, -0.005969, -0.003408, -0.001148, -0.007366, -0.011179, -0.017441, -0.014565, -0.006643, -0.013318, -0.017793, -0.024569, -0.011021
#*# 	0.039350, 0.031489, 0.035006, 0.030499, 0.020306, 0.012740, 0.003336, 0.002100, 0.004965, 0.011717, 0.007908, -0.005667, -0.004214, -0.001715, -0.000446, 0.001074, -0.005273, -0.008512, -0.015595, -0.014122, -0.007400, -0.013322, -0.019699, -0.021888, -0.019519
#*# 	0.046335, 0.037701, 0.039579, 0.036621, 0.023971, 0.014993, 0.007323, 0.004735, 0.007330, 0.013015, 0.009796, -0.004806, -0.003220, -0.002829, 0.000100, 0.000599, -0.006312, -0.011494, -0.017764, -0.017416, -0.012517, -0.018201, -0.025199, -0.027619, -0.029325
#*# 	0.046914, 0.035165, 0.038366, 0.034887, 0.022202, 0.013185, 0.003655, 0.001290, 0.002855, 0.008297, 0.003158, -0.010767, -0.009311, -0.010500, -0.008889, -0.006384, -0.012567, -0.018455, -0.026154, -0.025352, -0.021346, -0.029770, -0.035645, -0.042579, -0.044978
#*# 	0.047425, 0.036542, 0.037269, 0.033070, 0.022401, 0.012954, 0.002762, -0.001498, 0.000500, 0.004976, 0.000832, -0.016061, -0.017054, -0.015927, -0.013967, -0.012708, -0.018816, -0.024991, -0.032392, -0.032171, -0.028729, -0.037545, -0.044142, -0.054779, -0.063370
#*# 	0.048705, 0.036383, 0.036878, 0.034228, 0.022196, 0.013039, 0.002705, 0.000302, 0.000059, 0.005561, -0.001081, -0.017490, -0.018820, -0.019841, -0.018895, -0.016878, -0.024316, -0.027620, -0.034813, -0.036070, -0.032783, -0.042221, -0.049165, -0.060981, -0.070983
#*# 	0.051340, 0.039996, 0.039242, 0.035368, 0.027824, 0.017461, 0.008854, 0.002709, 0.003424, 0.007700, 0.002469, -0.014956, -0.016098, -0.018382, -0.018580, -0.016132, -0.023081, -0.028588, -0.036122, -0.036760, -0.034882, -0.044011, -0.052130, -0.063740, -0.075121
#*# 	0.052797, 0.039547, 0.040129, 0.036848, 0.026810, 0.018004, 0.006956, 0.002782, 0.001791, 0.005684, -0.001724, -0.016774, -0.017675, -0.021308, -0.022422, -0.021119, -0.026632, -0.032370, -0.041104, -0.041817, -0.040164, -0.051253, -0.060068, -0.071474, -0.082590
#*# 	0.056802, 0.045166, 0.043513, 0.041087, 0.031436, 0.021174, 0.011208, 0.003066, 0.001036, 0.003807, -0.001287, -0.018522, -0.021895, -0.024462, -0.025150, -0.024375, -0.031788, -0.035709, -0.045133, -0.047543, -0.047233, -0.056311, -0.066797, -0.078571, -0.087908
#*# 	0.067582, 0.054214, 0.053752, 0.050298, 0.040460, 0.030457, 0.016230, 0.010185, 0.007323, 0.008257, 0.000138, -0.017222, -0.017552, -0.021104, -0.022723, -0.022672, -0.029007, -0.032527, -0.042428, -0.047058, -0.048466, -0.059032, -0.068309, -0.080995, -0.093063
#*# 	0.079212, 0.068252, 0.066418, 0.064599, 0.052656, 0.039915, 0.026331, 0.017728, 0.013664, 0.014416, 0.006500, -0.011203, -0.011370, -0.014674, -0.016253, -0.016450, -0.021775, -0.028593, -0.038840, -0.044372, -0.046357, -0.057708, -0.068502, -0.080863, -0.093995
#*# 	0.094396, 0.083065, 0.082948, 0.080797, 0.066898, 0.052626, 0.037251, 0.028724, 0.023107, 0.022627, 0.014666, -0.003041, -0.001942, -0.006278, -0.010450, -0.011040, -0.018301, -0.024530, -0.035834, -0.040157, -0.043564, -0.054239, -0.065384, -0.077897, -0.092159
#*# 	0.117700, 0.106579, 0.106777, 0.101582, 0.086700, 0.072307, 0.057937, 0.047971, 0.042066, 0.040641, 0.033279, 0.014980, 0.015373, 0.009204, 0.001778, -0.001977, -0.010849, -0.018124, -0.028475, -0.032734, -0.035096, -0.044707, -0.057466, -0.071267, -0.083658
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 270.0
#*# min_y = 30.0
#*# max_y = 270.0
#*#
#*# [probe]
#*# z_offset = -0.821
#*#
#*# [beacon model default]
#*# model_coef = 1.4651648776588897,
#*# 	1.7814820734920256,
#*# 	0.7649239974193266,
#*# 	0.3860679958165501,
#*# 	0.277491192083721,
#*# 	0.20428238489377565,
#*# 	-0.0544384750644775,
#*# 	-0.07091063363171587,
#*# 	0.14696269033581832,
#*# 	0.10132344645480006
#*# model_domain = 3.1843248785002355e-07,3.3403658574366056e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 48.384588
#*# model_offset = -0.34700
