# THIS CONFIG IS FOR USE WITH Beacon & Mellow SB2040

# Required Configs, Always include these
[include mainsail.cfg]
[include macros/*.cfg]
[include scripts/*.cfg]

#####################################################################
#   MCU / Octopus v1.1 / SB2040
#####################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_25002D000150335331383520-if00
# serial: platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.3:1.0
restart_method: command

[mcu SB2040]
canbus_uuid: 1b89fd606a4c

[temperature_sensor Octopus]
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 0
max_temp: 100

[temperature_sensor SB2040]
sensor_type: temperature_mcu
sensor_mcu: SB2040
min_temp: 0
max_temp: 100

[temperature_sensor RPi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100


#####################################################################
#   Machine
#####################################################################

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 8000
max_z_velocity: 15
max_z_accel: 350
square_corner_velocity: 5.0

[idle_timeout]
timeout: 1800


#####################################################################
#   X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: SB2040:gpio29
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 75
homing_retract_dist: 5

[tmc2209 stepper_x]
uart_pin: PC4
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: PG9
position_min: 0
position_endstop: 307
position_max: 307
homing_speed: 75
homing_retract_dist: 5

[tmc2209 stepper_y]
uart_pin: PD11
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Z Stepper Settings
#####################################################################

[stepper_z]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_max: 290
position_min: -2.5
homing_speed: 10
second_homing_speed: 3
homing_retract_dist: 0


[tmc2209 stepper_z]
uart_pin: PC6
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z2]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Extruder / CW2
#####################################################################

[extruder]
step_pin: SB2040:gpio9
dir_pin: !SB2040:gpio10
enable_pin: !SB2040:gpio7
rotation_distance: 22.6789511
gear_ratio: 50:10
microsteps: 32
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: SB2040:gpio6
sensor_pin: SB2040:gpio27
sensor_type: ATC Semitec 104NT-4-R025H42G
min_temp: 10
max_temp: 315
max_extrude_only_distance: 500
max_extrude_cross_section: 5.0
max_power: 1.0
min_extrude_temp: 170
pressure_advance: 0.02
pressure_advance_smooth_time: 0.020

[tmc2209 extruder]
uart_pin: SB2040:gpio8
interpolate: false
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[firmware_retraction]
retract_length: 0.8
retract_speed: 30
unretract_extra_length: 0.0
unretract_speed: 30


#####################################################################
#   ADXL / Input Shaper
#####################################################################

[adxl345]
cs_pin: SB2040:gpio1
spi_software_sclk_pin: SB2040:gpio0
spi_software_mosi_pin: SB2040:gpio3
spi_software_miso_pin: SB2040:gpio2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345
probe_points: 150, 150, 20


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA2
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
max_power: 1
pwm_cycle_time: 0.0166
min_temp: 0
max_temp: 120


#####################################################################
#   Beacon
#####################################################################

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_8E79821B4E4B333448202020FF0A1818-if00
x_offset: 0
y_offset: 17.5
mesh_main_direction: x
mesh_runs: 2


#####################################################################
#   Bed Mesh
#####################################################################

[bed_mesh]
speed: 400
mesh_min: 30,30
mesh_max: 270,270
probe_count: 25,25
algorithm: bicubic


#####################################################################
#   Z-Tilt
#####################################################################

[z_tilt]
z_positions:
   -50, 18
   150, 348
   350, 18
points:
   30, 12.5
   150, 270
   270, 12.5
speed: 400
retries: 10
retry_tolerance: 0.004
horizontal_move_z: 10


#####################################################################
#   Safe Home
#####################################################################

[safe_z_home]
home_xy_position: 150,150
speed: 400
z_hop: 10


#####################################################################
#   Fan Control
#####################################################################

[fan]
pin: SB2040:gpio13
kick_start_time: 0.5
off_below: 0.10

[heater_fan hotend_fan]
pin: SB2040:gpio14
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[controller_fan Controller_Fan]
pin: PD12
kick_start_time: 0.5
heater: heater_bed
fan_speed: 0.50

[controller_fan SB2040_Fan]
pin: SB2040:gpio15
kick_start_time: 0.5
heater: heater_bed
fan_speed: 1.0


#####################################################################
# 	Chamber Thermistor
#####################################################################

[temperature_sensor Chamber]
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF5
min_temp: 0
max_temp: 100
gcode_id: chamber_th

[temperature_sensor Tool_Head]
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: SB2040:gpio26
min_temp: 0
max_temp: 100


#####################################################################
# EXP1 / EXP2 (display) pins
#####################################################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>


#####################################################################
#   Displays
#####################################################################

[display]
lcd_type: uc1701
cs_pin: EXP1_3
a0_pin: EXP1_4
rst_pin: EXP1_5
encoder_pins: ^EXP2_5, ^EXP2_3
click_pin: ^!EXP1_2
contrast: 63
spi_software_miso_pin: EXP2_1
spi_software_mosi_pin: EXP2_6
spi_software_sclk_pin: EXP2_2

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.865
#*# pid_ki = 4.335
#*# pid_kd = 58.553
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 65.636
#*# pid_ki = 4.376
#*# pid_kd = 246.136
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.006628, -0.005356, -0.013664, -0.027695, -0.035923, -0.033625, -0.021644, -0.019564, -0.018993, -0.019430, -0.015459, -0.015502, -0.009564, -0.005794, -0.004833, -0.004652, -0.000874, -0.002649, -0.001633, 0.003685, 0.001009, 0.003249, -0.003406, -0.009365, -0.016023
#*# 	  -0.011716, -0.013149, -0.019206, -0.030474, -0.034671, -0.035919, -0.029532, -0.027694, -0.026226, -0.018800, -0.018077, -0.018338, -0.021298, -0.014093, -0.010910, -0.006324, -0.005577, -0.008638, -0.008227, -0.006598, -0.004633, -0.004422, -0.002683, -0.014157, -0.022096
#*# 	  -0.015932, -0.021553, -0.032271, -0.038875, -0.045696, -0.036493, -0.033613, -0.031142, -0.035941, -0.029092, -0.022109, -0.017341, -0.020304, -0.020786, -0.022772, -0.020181, -0.013686, -0.014373, -0.006907, -0.007506, -0.013303, -0.021221, -0.018983, -0.022881, -0.025581
#*# 	  -0.027412, -0.027927, -0.031684, -0.043595, -0.047765, -0.049019, -0.045448, -0.040191, -0.035395, -0.028620, -0.022035, -0.031366, -0.033969, -0.035769, -0.029883, -0.018939, -0.015018, -0.018311, -0.021503, -0.023277, -0.023637, -0.019924, -0.018555, -0.023389, -0.032763
#*# 	  -0.037185, -0.039337, -0.047160, -0.051351, -0.049802, -0.047767, -0.046681, -0.051134, -0.049455, -0.044472, -0.029325, -0.033090, -0.034927, -0.039463, -0.041576, -0.036158, -0.031636, -0.020267, -0.020800, -0.022780, -0.034645, -0.037237, -0.036441, -0.032366, -0.037544
#*# 	  -0.045797, -0.044403, -0.047589, -0.056656, -0.057003, -0.056894, -0.058146, -0.053802, -0.054728, -0.043632, -0.038685, -0.042533, -0.049323, -0.047479, -0.045386, -0.036674, -0.029499, -0.026842, -0.031448, -0.037113, -0.036238, -0.038921, -0.031708, -0.037651, -0.050510
#*# 	  -0.047147, -0.048451, -0.048469, -0.053029, -0.054023, -0.051924, -0.057580, -0.055268, -0.058787, -0.047480, -0.040640, -0.041874, -0.047408, -0.048899, -0.047414, -0.038512, -0.032125, -0.028517, -0.028165, -0.039108, -0.039945, -0.042304, -0.033771, -0.040911, -0.050354
#*# 	  -0.035104, -0.038556, -0.042777, -0.051314, -0.052090, -0.050473, -0.044974, -0.047788, -0.052312, -0.048803, -0.038250, -0.039855, -0.040064, -0.043668, -0.042179, -0.040046, -0.032150, -0.024609, -0.025473, -0.032843, -0.037880, -0.039639, -0.042660, -0.040450, -0.048640
#*# 	  -0.030535, -0.030703, -0.030390, -0.042379, -0.045988, -0.048205, -0.045638, -0.044701, -0.043495, -0.037546, -0.032894, -0.037179, -0.040906, -0.040272, -0.034978, -0.028380, -0.025673, -0.026127, -0.031342, -0.035797, -0.035175, -0.024584, -0.027004, -0.033850, -0.050570
#*# 	  -0.024572, -0.030798, -0.037740, -0.046892, -0.048527, -0.047286, -0.045471, -0.044795, -0.051726, -0.046565, -0.038502, -0.034217, -0.036528, -0.034333, -0.040007, -0.039308, -0.037555, -0.030105, -0.026511, -0.030555, -0.027566, -0.035990, -0.040349, -0.049135, -0.050347
#*# 	  -0.016605, -0.019691, -0.026340, -0.040585, -0.047103, -0.046631, -0.046692, -0.039778, -0.044675, -0.038807, -0.030030, -0.036757, -0.038383, -0.033499, -0.030366, -0.029577, -0.030972, -0.034613, -0.034943, -0.037342, -0.027672, -0.026772, -0.031019, -0.047163, -0.062852
#*# 	  -0.005878, -0.013223, -0.021722, -0.034532, -0.038584, -0.034575, -0.035740, -0.036843, -0.038347, -0.029978, -0.022993, -0.023176, -0.025078, -0.024466, -0.024976, -0.028749, -0.027635, -0.028726, -0.023187, -0.024131, -0.022823, -0.027743, -0.034196, -0.042968, -0.052640
#*# 	  0.016790, 0.005982, -0.004923, -0.018886, -0.024484, -0.026159, -0.018307, -0.019660, -0.018538, -0.014934, -0.008156, -0.013483, -0.013351, -0.008889, -0.011604, -0.014480, -0.017715, -0.016589, -0.015484, -0.011161, -0.013582, -0.012297, -0.021782, -0.037700, -0.043226
#*# 	  0.016589, 0.011588, 0.005409, -0.006140, -0.014582, -0.016502, -0.016157, -0.012542, -0.013051, -0.005499, -0.000338, -0.004346, -0.008959, -0.003561, -0.006248, -0.005351, -0.010730, -0.009528, -0.008990, -0.011372, -0.009958, -0.010705, -0.014045, -0.031499, -0.042924
#*# 	  0.024618, 0.011633, 0.004652, -0.005949, -0.013897, -0.010963, -0.010411, -0.007491, -0.012249, -0.007714, -0.000691, 0.000626, -0.003280, -0.001960, -0.003387, -0.008344, -0.007546, -0.006667, -0.004399, -0.008481, -0.012576, -0.018184, -0.022321, -0.033341, -0.042815
#*# 	  0.018268, 0.008478, 0.004872, -0.008184, -0.016343, -0.019770, -0.016658, -0.013749, -0.013680, -0.009264, -0.002517, -0.004994, -0.010362, -0.010452, -0.009786, -0.010137, -0.009777, -0.010448, -0.015033, -0.019978, -0.022300, -0.022785, -0.026464, -0.037502, -0.051926
#*# 	  0.017651, 0.006534, -0.000740, -0.013722, -0.014922, -0.019283, -0.017362, -0.018715, -0.020290, -0.013781, -0.004106, -0.011419, -0.012222, -0.011981, -0.018708, -0.020853, -0.019572, -0.013858, -0.013817, -0.018893, -0.031974, -0.034218, -0.039951, -0.045765, -0.057475
#*# 	  0.017340, 0.007763, -0.000253, -0.011842, -0.019062, -0.019451, -0.019115, -0.018885, -0.018733, -0.012116, -0.009297, -0.011499, -0.016342, -0.014790, -0.019499, -0.020308, -0.017177, -0.017159, -0.018974, -0.025279, -0.029765, -0.033762, -0.040069, -0.053238, -0.066273
#*# 	  0.019256, 0.011630, 0.004997, -0.005409, -0.009580, -0.009913, -0.014825, -0.015597, -0.013356, -0.007365, -0.001674, -0.006546, -0.011609, -0.012544, -0.020236, -0.019482, -0.015610, -0.016314, -0.019567, -0.028900, -0.034446, -0.038157, -0.038940, -0.053964, -0.066536
#*# 	  0.022247, 0.015348, 0.009862, -0.004362, -0.011047, -0.014265, -0.014698, -0.014305, -0.015119, -0.008506, -0.007493, -0.009577, -0.015934, -0.017894, -0.021687, -0.022464, -0.019736, -0.023105, -0.025959, -0.030574, -0.037485, -0.042451, -0.045364, -0.059754, -0.074431
#*# 	  0.027881, 0.017126, 0.013275, -0.000579, -0.005972, -0.011097, -0.013076, -0.013540, -0.011737, -0.008352, -0.005821, -0.012291, -0.022827, -0.023227, -0.028030, -0.024625, -0.024411, -0.027226, -0.032260, -0.036911, -0.046730, -0.050095, -0.051444, -0.068554, -0.083272
#*# 	  0.033191, 0.023420, 0.015270, 0.001540, -0.004579, -0.010649, -0.013588, -0.013858, -0.014110, -0.008874, -0.008595, -0.015681, -0.024005, -0.027655, -0.030188, -0.028768, -0.029415, -0.032347, -0.035330, -0.038454, -0.048141, -0.052275, -0.057764, -0.071894, -0.084089
#*# 	  0.045809, 0.033304, 0.023382, 0.010076, 0.001914, -0.003151, -0.006220, -0.006800, -0.007010, -0.002391, -0.007081, -0.014980, -0.022017, -0.024424, -0.026397, -0.026272, -0.026675, -0.031628, -0.034278, -0.039894, -0.044164, -0.049271, -0.055637, -0.071827, -0.086697
#*# 	  0.049736, 0.041850, 0.029880, 0.016732, 0.009356, 0.002026, -0.002531, -0.003915, -0.005967, 0.000520, 0.000622, -0.009002, -0.017341, -0.020822, -0.025683, -0.027700, -0.024742, -0.030357, -0.035028, -0.039516, -0.046274, -0.049085, -0.057138, -0.072861, -0.087757
#*# 	  0.064797, 0.055522, 0.045140, 0.027732, 0.019269, 0.010604, 0.006387, 0.004806, 0.003737, 0.008631, 0.007504, -0.001557, -0.008695, -0.011962, -0.015536, -0.021365, -0.022516, -0.027238, -0.030947, -0.036009, -0.042782, -0.044898, -0.056262, -0.070912, -0.085136
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 270.0
#*# min_y = 30.0
#*# max_y = 270.0
#*#
#*# [probe]
#*# z_offset = -0.821
#*#
#*# [beacon model default]
#*# model_coef = 1.4651648776588897,
#*# 	  1.7814820734920256,
#*# 	  0.7649239974193266,
#*# 	  0.3860679958165501,
#*# 	  0.277491192083721,
#*# 	  0.20428238489377565,
#*# 	  -0.0544384750644775,
#*# 	  -0.07091063363171587,
#*# 	  0.14696269033581832,
#*# 	  0.10132344645480006
#*# model_domain = 3.1843248785002355e-07,3.3403658574366056e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 48.384588
#*# model_offset = -0.41500
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 67.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 45.6
