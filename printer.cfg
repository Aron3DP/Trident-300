# THIS CONFIG IS FOR USE WITH Beacon & Mellow SB2040

# Required Configs, Always include these
[include mainsail.cfg]
[include macros/*.cfg]
[include scripts/*.cfg]

#####################################################################
#   MCU / Octopus v1.1 / SB2040
#####################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_25002D000150335331383520-if00
# serial: platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.3:1.0
restart_method: command

[mcu SB2040]
canbus_uuid: 1b89fd606a4c

[temperature_sensor Octopus]
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 0
max_temp: 100

[temperature_sensor SB2040]
sensor_type: temperature_mcu
sensor_mcu: SB2040
min_temp: 0
max_temp: 100

[temperature_sensor RPi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100


#####################################################################
#   Machine
#####################################################################

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 8000
max_z_velocity: 15
max_z_accel: 350
square_corner_velocity: 5.0

[idle_timeout]
timeout: 1800


#####################################################################
#   X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: SB2040:gpio29
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 75
homing_retract_dist: 5

[tmc2209 stepper_x]
uart_pin: PC4
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: PG9
position_min: 0
position_endstop: 307
position_max: 307
homing_speed: 75
homing_retract_dist: 5

[tmc2209 stepper_y]
uart_pin: PD11
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Z Stepper Settings
#####################################################################

[stepper_z]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_max: 290
position_min: -2.5
homing_speed: 10
second_homing_speed: 3
homing_retract_dist: 0


[tmc2209 stepper_z]
uart_pin: PC6
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z2]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Extruder / CW2
#####################################################################

[extruder]
step_pin: SB2040:gpio9
dir_pin: !SB2040:gpio10
enable_pin: !SB2040:gpio7
rotation_distance: 22.6789511
gear_ratio: 50:10
microsteps: 32
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: SB2040:gpio6
sensor_pin: SB2040:gpio27
sensor_type: ATC Semitec 104NT-4-R025H42G
min_temp: 10
max_temp: 315
max_extrude_only_distance: 500
max_extrude_cross_section: 5.0
max_power: 1.0
min_extrude_temp: 170
pressure_advance: 0.02
pressure_advance_smooth_time: 0.020

[tmc2209 extruder]
uart_pin: SB2040:gpio8
interpolate: false
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[firmware_retraction]
retract_length: 0.8
retract_speed: 30
unretract_extra_length: 0.0
unretract_speed: 30


#####################################################################
#   ADXL / Input Shaper
#####################################################################

[adxl345]
cs_pin: SB2040:gpio1
spi_software_sclk_pin: SB2040:gpio0
spi_software_mosi_pin: SB2040:gpio3
spi_software_miso_pin: SB2040:gpio2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345
probe_points: 150, 150, 20


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA2
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
max_power: 1
pwm_cycle_time: 0.0166
min_temp: 0
max_temp: 120


#####################################################################
#   Beacon
#####################################################################

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_8E79821B4E4B333448202020FF0A1818-if00
x_offset: 0
y_offset: 17.5
mesh_main_direction: x
mesh_runs: 2


#####################################################################
#   Bed Mesh
#####################################################################

[bed_mesh]
speed: 400
mesh_min: 30,30
mesh_max: 270,270
probe_count: 25,25
algorithm: bicubic


#####################################################################
#   Z-Tilt
#####################################################################

[z_tilt]
z_positions:
   -50, 18
   150, 348
   350, 18
points:
   30, 12.5
   150, 270
   270, 12.5
speed: 400
retries: 10
retry_tolerance: 0.0075
horizontal_move_z: 10


#####################################################################
#   Safe Home
#####################################################################

[safe_z_home]
home_xy_position: 150,150
speed: 400
z_hop: 10


#####################################################################
#   Fan Control
#####################################################################

[fan]
pin: SB2040:gpio13
kick_start_time: 0.5
off_below: 0.10

[heater_fan hotend_fan]
pin: SB2040:gpio14
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[controller_fan Controller_Fan]
pin: PD12
kick_start_time: 0.5
heater: heater_bed
fan_speed: 0.50

[controller_fan SB2040_Fan]
pin: SB2040:gpio15
kick_start_time: 0.5
heater: heater_bed
fan_speed: 1.0


#####################################################################
# 	Chamber Thermistor
#####################################################################

[temperature_sensor Chamber]
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF5
min_temp: 0
max_temp: 100
gcode_id: chamber_th

[temperature_sensor Tool_Head]
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: SB2040:gpio26
min_temp: 0
max_temp: 100


#####################################################################
# EXP1 / EXP2 (display) pins
#####################################################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>


#####################################################################
#   Displays
#####################################################################

[display]
lcd_type: uc1701
cs_pin: EXP1_3
a0_pin: EXP1_4
rst_pin: EXP1_5
encoder_pins: ^EXP2_5, ^EXP2_3
click_pin: ^!EXP1_2
contrast: 63
spi_software_miso_pin: EXP2_1
spi_software_mosi_pin: EXP2_6
spi_software_sclk_pin: EXP2_2

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.865
#*# pid_ki = 4.335
#*# pid_kd = 58.553
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 65.636
#*# pid_ki = 4.376
#*# pid_kd = 246.136
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.030083, 0.035910, 0.030648, 0.019282, 0.007398, 0.014248, 0.020895, 0.028833, 0.024301, 0.030887, 0.035565, 0.028226, 0.033422, 0.038003, 0.039137, 0.042604, 0.047489, 0.039838, 0.049085, 0.048048, 0.054567, 0.048098, 0.049635, 0.042922, 0.033783
#*# 	0.029937, 0.032144, 0.019322, 0.008854, -0.003661, 0.006289, 0.009300, 0.012790, 0.019813, 0.022173, 0.028192, 0.026359, 0.022951, 0.023769, 0.032363, 0.031900, 0.036293, 0.032140, 0.037519, 0.034668, 0.033234, 0.039762, 0.035463, 0.032687, 0.019656
#*# 	0.015305, 0.012464, 0.007778, -0.004305, -0.007805, -0.005469, 0.001937, -0.001819, 0.002007, 0.011219, 0.013059, 0.012654, 0.009537, 0.009701, 0.011942, 0.018446, 0.017983, 0.026309, 0.025391, 0.026410, 0.017509, 0.020168, 0.021065, 0.015042, 0.011066
#*# 	-0.000374, 0.002618, 0.002324, -0.012359, -0.019007, -0.020136, -0.013512, -0.010383, -0.007845, 0.003717, 0.006674, 0.002730, -0.005740, -0.000129, 0.001605, 0.012239, 0.011832, 0.015501, 0.010099, 0.012486, 0.009248, 0.009049, 0.012739, 0.004246, -0.000229
#*# 	-0.012088, -0.010219, -0.016212, -0.026344, -0.029528, -0.023526, -0.024780, -0.020621, -0.018289, -0.016053, -0.007575, -0.011216, -0.011982, -0.012625, -0.009141, -0.008659, -0.000374, 0.003002, 0.006826, 0.000476, 0.000740, -0.001161, -0.006566, -0.008218, -0.013024
#*# 	-0.024392, -0.021069, -0.027186, -0.033681, -0.037462, -0.034718, -0.036213, -0.030041, -0.029285, -0.024328, -0.015839, -0.021802, -0.023301, -0.025610, -0.018899, -0.013970, -0.005859, -0.007191, -0.006853, -0.012895, -0.008054, -0.007802, -0.010873, -0.014215, -0.024085
#*# 	-0.029007, -0.030002, -0.031101, -0.039593, -0.039901, -0.037993, -0.035877, -0.033062, -0.035690, -0.030385, -0.022385, -0.026705, -0.027236, -0.026230, -0.026669, -0.018807, -0.015593, -0.010781, -0.011432, -0.015041, -0.013863, -0.015824, -0.018099, -0.024073, -0.031569
#*# 	-0.021698, -0.023546, -0.027103, -0.036132, -0.037847, -0.034759, -0.029954, -0.032651, -0.032535, -0.028465, -0.022233, -0.019599, -0.025511, -0.023302, -0.024641, -0.017012, -0.013151, -0.006447, -0.008761, -0.013318, -0.016500, -0.014790, -0.017475, -0.023809, -0.031588
#*# 	-0.013433, -0.017650, -0.021203, -0.033724, -0.033632, -0.031312, -0.028064, -0.027929, -0.031536, -0.024755, -0.020534, -0.021629, -0.021772, -0.021910, -0.020604, -0.017660, -0.011199, -0.010371, -0.009334, -0.014603, -0.013109, -0.013147, -0.013368, -0.022428, -0.031957
#*# 	-0.013149, -0.017894, -0.026991, -0.034396, -0.035763, -0.034163, -0.029581, -0.032784, -0.038818, -0.028241, -0.020965, -0.021052, -0.020748, -0.021104, -0.021430, -0.021944, -0.017768, -0.013557, -0.014814, -0.015898, -0.014273, -0.016715, -0.017620, -0.026589, -0.034674
#*# 	-0.008649, -0.015416, -0.020476, -0.032689, -0.034349, -0.034005, -0.032723, -0.033975, -0.034990, -0.027716, -0.019422, -0.020654, -0.023957, -0.022898, -0.021911, -0.018279, -0.018258, -0.016656, -0.018749, -0.019477, -0.017703, -0.016417, -0.021466, -0.031014, -0.042010
#*# 	0.003360, -0.005295, -0.010738, -0.023641, -0.026673, -0.022949, -0.023591, -0.023470, -0.025713, -0.016586, -0.008596, -0.012153, -0.013197, -0.013320, -0.015246, -0.012324, -0.011831, -0.010222, -0.008635, -0.012945, -0.010225, -0.011587, -0.016971, -0.025873, -0.035892
#*# 	0.018182, 0.011382, 0.005033, -0.008043, -0.014004, -0.011517, -0.011325, -0.011170, -0.010992, -0.002133, 0.006696, 0.000547, -0.001032, -0.001699, -0.002717, -0.001487, 0.001293, 0.000665, 0.003867, -0.001464, -0.001620, -0.002757, -0.008558, -0.016766, -0.028600
#*# 	0.026348, 0.019124, 0.013101, 0.002868, -0.006487, -0.005104, -0.005992, -0.002097, -0.000257, 0.003517, 0.011592, 0.007180, 0.004404, 0.006170, 0.005256, 0.004829, 0.005590, 0.003941, 0.008134, 0.002303, 0.000218, 0.002051, -0.004424, -0.015183, -0.025824
#*# 	0.027382, 0.019761, 0.016377, 0.004716, -0.003514, -0.006137, -0.003479, -0.000707, 0.000599, 0.002071, 0.009286, 0.007907, 0.004800, 0.005683, 0.005680, 0.005391, 0.004426, 0.006053, 0.005411, -0.000558, -0.003500, -0.002485, -0.008861, -0.016818, -0.030721
#*# 	0.024469, 0.018676, 0.014974, 0.002211, -0.006171, -0.009077, -0.005294, -0.001749, -0.001835, 0.002446, 0.007561, 0.005764, 0.001994, 0.004590, 0.003036, 0.001463, 0.002576, 0.003192, 0.001668, -0.004711, -0.007089, -0.010837, -0.014430, -0.023556, -0.036124
#*# 	0.028390, 0.019901, 0.013296, 0.001349, -0.006881, -0.008933, -0.007159, -0.005164, -0.003444, 0.001210, 0.005988, 0.001248, 0.000985, 0.001875, -0.000709, -0.003900, -0.000474, 0.000015, 0.000033, -0.006210, -0.011669, -0.014966, -0.022130, -0.031139, -0.044450
#*# 	0.028963, 0.020871, 0.011744, 0.001310, -0.005405, -0.005090, -0.006332, -0.003284, -0.002677, 0.004204, 0.009597, 0.002891, 0.000419, 0.001644, -0.002155, -0.002638, 0.000577, -0.000673, -0.000280, -0.007963, -0.011938, -0.017149, -0.024384, -0.034359, -0.048392
#*# 	0.035781, 0.026366, 0.022529, 0.009445, 0.005466, 0.002704, 0.002368, 0.002082, 0.005289, 0.011825, 0.014112, 0.009936, 0.007889, 0.007231, 0.001808, 0.001751, 0.003990, 0.002323, 0.001590, -0.004887, -0.010432, -0.014662, -0.022381, -0.033591, -0.046819
#*# 	0.038972, 0.029203, 0.024722, 0.014587, 0.008392, 0.006198, 0.004984, 0.005121, 0.006309, 0.011511, 0.014344, 0.011941, 0.004752, 0.004289, -0.001424, 0.000029, 0.002602, -0.000521, -0.001824, -0.008295, -0.015307, -0.019339, -0.024758, -0.036679, -0.050344
#*# 	0.045617, 0.033353, 0.029006, 0.017308, 0.010922, 0.008468, 0.006812, 0.006539, 0.008189, 0.011972, 0.013978, 0.009796, 0.002129, -0.000356, -0.001676, -0.001215, -0.001600, -0.004482, -0.006688, -0.012264, -0.019713, -0.026590, -0.029377, -0.043382, -0.057468
#*# 	0.054828, 0.042309, 0.033028, 0.022990, 0.017337, 0.013340, 0.012297, 0.010394, 0.011363, 0.016755, 0.016300, 0.010247, 0.003779, -0.000033, -0.002141, -0.001844, -0.001289, -0.003191, -0.004920, -0.010565, -0.018241, -0.023729, -0.028412, -0.041340, -0.056527
#*# 	0.067746, 0.053226, 0.044491, 0.033285, 0.027153, 0.021091, 0.019351, 0.018009, 0.019133, 0.023346, 0.021556, 0.013653, 0.008773, 0.006007, 0.002449, 0.002743, 0.003735, -0.000035, -0.002100, -0.008498, -0.014697, -0.020362, -0.026703, -0.038263, -0.055026
#*# 	0.078189, 0.068418, 0.057556, 0.044262, 0.037290, 0.031985, 0.028773, 0.029158, 0.026415, 0.032247, 0.031382, 0.023519, 0.015936, 0.013932, 0.008769, 0.007527, 0.008400, 0.005440, 0.000847, -0.004635, -0.010564, -0.012999, -0.023798, -0.035983, -0.050011
#*# 	0.090530, 0.082740, 0.072467, 0.054989, 0.048865, 0.041630, 0.035754, 0.036859, 0.036269, 0.041132, 0.042460, 0.033322, 0.025535, 0.022459, 0.019559, 0.015234, 0.015501, 0.010797, 0.008022, 0.000899, -0.004356, -0.006824, -0.016815, -0.031392, -0.046128
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 270.0
#*# min_y = 30.0
#*# max_y = 270.0
#*#
#*# [probe]
#*# z_offset = -0.821
#*#
#*# [beacon model default]
#*# model_coef = 1.4651648776588897,
#*# 	  1.7814820734920256,
#*# 	  0.7649239974193266,
#*# 	  0.3860679958165501,
#*# 	  0.277491192083721,
#*# 	  0.20428238489377565,
#*# 	  -0.0544384750644775,
#*# 	  -0.07091063363171587,
#*# 	  0.14696269033581832,
#*# 	  0.10132344645480006
#*# model_domain = 3.1843248785002355e-07,3.3403658574366056e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 48.384588
#*# model_offset = -0.46600
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 70.4
#*# shaper_type_y = zv
#*# shaper_freq_y = 46.4
