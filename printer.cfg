# THIS CONFIG IS FOR USE WITH Beacon & Mellow SB2040

# Required Configs, Always include these
[include mainsail.cfg]
[include macros/*.cfg]
[include KAMP/Line_Purge.cfg]
[include scripts/*.cfg]

#####################################################################
#   MCU / Octopus v1.1 / SB2040
#####################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_25002D000150335331383520-if00
# serial: platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.3:1.0
restart_method: command

[mcu SB2040]
canbus_uuid: 1b89fd606a4c

[temperature_sensor Octopus]
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 0
max_temp: 100

[temperature_sensor SB2040]
sensor_type: temperature_mcu
sensor_mcu: SB2040
min_temp: 0
max_temp: 100

[temperature_sensor RPi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100


#####################################################################
#   Machine
#####################################################################

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 8000
max_z_velocity: 15
max_z_accel: 350
square_corner_velocity: 5.0

[idle_timeout]
timeout: 1800


#####################################################################
#   X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: SB2040:gpio29
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 75
homing_retract_dist: 5

[tmc2209 stepper_x]
uart_pin: PC4
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: PG9
position_min: 0
position_endstop: 307
position_max: 307
homing_speed: 75
homing_retract_dist: 5

[tmc2209 stepper_y]
uart_pin: PD11
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Z Stepper Settings
#####################################################################

[stepper_z]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_max: 290
position_min: -2.5
homing_speed: 10
second_homing_speed: 3
homing_retract_dist: 0


[tmc2209 stepper_z]
uart_pin: PC6
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z2]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Extruder / CW2
#####################################################################

[extruder]
step_pin: SB2040:gpio9
dir_pin: !SB2040:gpio10
enable_pin: !SB2040:gpio7
rotation_distance: 22.6789511
gear_ratio: 50:10
microsteps: 32
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: SB2040:gpio6
sensor_pin: SB2040:gpio27
sensor_type: ATC Semitec 104NT-4-R025H42G
min_temp: 10
max_temp: 315
max_extrude_only_distance: 500
max_extrude_cross_section: 5.0
max_power: 1.0
min_extrude_temp: 170
pressure_advance: 0.02
pressure_advance_smooth_time: 0.020

[tmc2209 extruder]
uart_pin: SB2040:gpio8
interpolate: false
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[firmware_retraction]
retract_length: 0.8
retract_speed: 30
unretract_extra_length: 0.0
unretract_speed: 30


#####################################################################
#   ADXL / Input Shaper
#####################################################################

[adxl345]
cs_pin: SB2040:gpio1
spi_software_sclk_pin: SB2040:gpio0
spi_software_mosi_pin: SB2040:gpio3
spi_software_miso_pin: SB2040:gpio2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345
probe_points: 150, 150, 20


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA2
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
max_power: 1
pwm_cycle_time: 0.0166
min_temp: 0
max_temp: 120


#####################################################################
#   Beacon
#####################################################################

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_8E79821B4E4B333448202020FF0A1818-if00
x_offset: 0
y_offset: 17.5
mesh_main_direction: x
mesh_runs: 2


#####################################################################
#   Bed Mesh
#####################################################################

[bed_mesh]
speed: 400
mesh_min: 30,30
mesh_max: 270,270
probe_count: 25,25
algorithm: bicubic


#####################################################################
#   Z-Tilt
#####################################################################

[z_tilt]
z_positions:
   -50, 18
   150, 348
   350, 18
points:
   30, 12.5
   150, 270
   270, 12.5
speed: 400
retries: 10
retry_tolerance: 0.0075
horizontal_move_z: 10


#####################################################################
#   Safe Home
#####################################################################

[safe_z_home]
home_xy_position: 150,150
speed: 400
z_hop: 10


#####################################################################
#   Fan Control
#####################################################################

[fan]
pin: SB2040:gpio13
kick_start_time: 0.5
off_below: 0.10

[heater_fan hotend_fan]
pin: SB2040:gpio14
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[controller_fan Controller_Fan]
pin: PD12
kick_start_time: 0.5
heater: heater_bed
fan_speed: 0.50

[controller_fan SB2040_Fan]
pin: SB2040:gpio15
kick_start_time: 0.5
heater: heater_bed
fan_speed: 1.0


#####################################################################
# 	Chamber Thermistor
#####################################################################

[temperature_sensor Chamber]
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF5
min_temp: 0
max_temp: 100
gcode_id: chamber_th

[temperature_sensor Tool_Head]
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: SB2040:gpio26
min_temp: 0
max_temp: 100


#####################################################################
# EXP1 / EXP2 (display) pins
#####################################################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>


#####################################################################
#   Displays
#####################################################################

[display]
lcd_type: uc1701
cs_pin: EXP1_3
a0_pin: EXP1_4
rst_pin: EXP1_5
encoder_pins: ^EXP2_5, ^EXP2_3
click_pin: ^!EXP1_2
contrast: 63
spi_software_miso_pin: EXP2_1
spi_software_mosi_pin: EXP2_6
spi_software_sclk_pin: EXP2_2

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 24.185
#*# pid_ki = 2.519
#*# pid_kd = 58.044
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 65.636
#*# pid_ki = 4.376
#*# pid_kd = 246.136
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.037800, 0.037379, 0.036411, 0.047039, 0.030789, 0.033622, 0.038942, 0.057404, 0.042113, 0.032364, 0.052846, 0.053603, 0.052307, 0.039009, 0.071750, 0.059437, 0.062847, 0.063134, 0.079974, 0.062404, 0.046900, 0.075990, 0.061806, 0.055216, 0.034708
#*# 	0.040836, 0.028934, 0.037528, 0.028461, 0.035829, 0.010193, 0.028792, 0.046153, 0.034016, 0.041116, 0.045675, 0.060151, 0.027872, 0.044396, 0.046408, 0.051100, 0.041744, 0.056303, 0.070057, 0.053637, 0.051324, 0.051764, 0.064971, 0.036658, 0.041221
#*# 	0.021852, 0.034386, 0.018145, 0.010456, 0.005440, 0.021032, 0.012630, 0.002914, 0.017972, 0.027393, 0.033794, 0.019588, 0.041995, 0.028951, 0.030547, 0.036883, 0.042517, 0.044970, 0.032078, 0.053512, 0.037781, 0.038223, 0.040767, 0.048262, 0.030184
#*# 	0.004980, 0.007665, 0.016262, -0.003090, -0.007804, -0.003115, 0.010679, -0.008079, 0.006849, 0.015633, 0.022505, 0.006167, 0.015692, 0.029330, 0.008800, 0.025734, 0.030993, 0.045685, 0.021403, 0.032797, 0.040841, 0.030038, 0.029720, 0.024644, 0.031954
#*# 	-0.021830, -0.011471, -0.012592, -0.019861, -0.023561, -0.028753, -0.005931, -0.010985, -0.007729, 0.001010, 0.017086, 0.003913, -0.007930, 0.002823, 0.008063, 0.012755, 0.007729, 0.032193, 0.022036, 0.020621, 0.021561, 0.029158, 0.019729, 0.005406, 0.008083
#*# 	-0.026504, -0.015729, -0.035600, -0.031412, -0.032825, -0.028415, -0.024580, -0.019079, -0.008751, -0.020920, -0.005487, -0.007670, -0.006967, -0.015318, -0.001555, 0.014708, 0.009071, 0.012703, 0.014423, 0.021559, 0.004254, 0.014765, 0.013433, 0.007536, 0.000192
#*# 	-0.038413, -0.035138, -0.034510, -0.048480, -0.032828, -0.036293, -0.032704, -0.027061, -0.018602, -0.021241, -0.022166, -0.015189, -0.013752, -0.011619, -0.016705, 0.007520, 0.003206, 0.005930, 0.009577, 0.007650, 0.008121, 0.001052, 0.015120, 0.001292, 0.001122
#*# 	-0.042378, -0.033891, -0.033512, -0.030433, -0.048638, -0.036147, -0.028767, -0.026813, -0.036155, -0.020718, -0.003990, -0.021626, -0.012234, -0.009390, 0.003536, -0.008965, 0.005196, 0.009267, 0.011522, 0.009266, 0.010255, 0.018586, 0.003498, 0.004848, -0.009635
#*# 	-0.031107, -0.036990, -0.025517, -0.037501, -0.038476, -0.033275, -0.028327, -0.025432, -0.035835, -0.011199, -0.011891, -0.010672, -0.008599, 0.001718, -0.002489, -0.006752, 0.006643, 0.011923, 0.012839, 0.005213, 0.020741, 0.015639, 0.015724, 0.010229, 0.001669
#*# 	-0.024715, -0.032276, -0.035185, -0.041321, -0.040055, -0.029369, -0.041978, -0.030451, -0.031715, -0.021463, -0.018179, -0.010291, -0.002697, -0.005255, -0.004107, -0.000782, 0.011865, 0.002460, 0.011181, 0.010322, 0.013572, 0.017397, 0.015826, 0.015424, 0.000517
#*# 	-0.033724, -0.035125, -0.042488, -0.044256, -0.044821, -0.041182, -0.045332, -0.029961, -0.036096, -0.024126, -0.012325, -0.005317, -0.010693, -0.015692, -0.006101, -0.002755, 0.001921, -0.001269, 0.015600, 0.008769, 0.012121, 0.015266, 0.014628, 0.005725, -0.008026
#*# 	-0.024166, -0.033007, -0.029957, -0.037241, -0.038926, -0.040080, -0.031020, -0.023255, -0.026614, -0.015108, -0.001692, 0.006107, -0.007680, -0.000794, 0.001977, 0.007317, 0.010601, 0.012615, 0.023186, 0.008632, 0.019368, 0.022940, 0.022240, 0.008034, 0.005083
#*# 	-0.013692, -0.015826, -0.018531, -0.025828, -0.035119, -0.018168, -0.021574, -0.017968, -0.013152, -0.001866, 0.010785, 0.003186, 0.015539, 0.011564, 0.013362, 0.018343, 0.028815, 0.025027, 0.024410, 0.028947, 0.030903, 0.033409, 0.026430, 0.030192, 0.016594
#*# 	-0.010266, -0.013040, -0.007652, -0.026514, -0.023075, -0.019991, -0.016431, -0.016069, -0.005611, 0.007128, 0.015956, 0.013567, 0.014676, 0.024718, 0.015507, 0.023396, 0.028060, 0.031246, 0.030704, 0.034824, 0.040386, 0.035287, 0.038592, 0.031018, 0.027306
#*# 	-0.013150, -0.013405, -0.013774, -0.016098, -0.022796, -0.027553, -0.017258, -0.009639, -0.004087, -0.004074, 0.018854, 0.015031, 0.014490, 0.019767, 0.029577, 0.026264, 0.024506, 0.033829, 0.035515, 0.034576, 0.030491, 0.044183, 0.038102, 0.033171, 0.023196
#*# 	-0.013677, -0.017715, -0.023328, -0.022353, -0.020364, -0.025822, -0.020111, -0.012412, -0.007534, -0.001782, 0.012001, 0.012604, 0.013347, 0.018622, 0.022134, 0.028245, 0.025107, 0.032994, 0.034886, 0.032107, 0.027923, 0.035913, 0.038107, 0.029307, 0.020057
#*# 	-0.017830, -0.018750, -0.023521, -0.031014, -0.031719, -0.029309, -0.022662, -0.021765, -0.007740, -0.001809, 0.007236, 0.007020, 0.009770, 0.015039, 0.013137, 0.024003, 0.025155, 0.028769, 0.032791, 0.033862, 0.030963, 0.028954, 0.029934, 0.023346, 0.017944
#*# 	-0.024592, -0.021704, -0.024704, -0.028948, -0.035177, -0.027854, -0.018353, -0.017139, -0.009907, 0.000825, 0.013586, 0.006307, 0.012468, 0.016737, 0.018559, 0.017750, 0.028051, 0.035571, 0.035782, 0.034338, 0.034017, 0.034575, 0.027232, 0.024107, 0.016139
#*# 	-0.014887, -0.018926, -0.016634, -0.022383, -0.022046, -0.021078, -0.015267, -0.011014, -0.006885, 0.007276, 0.015918, 0.016045, 0.015272, 0.025048, 0.023338, 0.026161, 0.032242, 0.036950, 0.039523, 0.036089, 0.037922, 0.038321, 0.037268, 0.029574, 0.019909
#*# 	-0.012459, -0.009904, -0.014609, -0.018086, -0.018537, -0.013563, -0.016567, -0.007719, -0.000959, 0.008365, 0.017536, 0.018506, 0.021105, 0.019118, 0.022949, 0.028102, 0.034431, 0.032946, 0.040147, 0.041748, 0.037107, 0.038258, 0.039081, 0.032604, 0.021087
#*# 	-0.010408, -0.013818, -0.014292, -0.018066, -0.017295, -0.017344, -0.015521, -0.008264, -0.001889, 0.009313, 0.016491, 0.019031, 0.015675, 0.017747, 0.021513, 0.025928, 0.031571, 0.032908, 0.038271, 0.036361, 0.035254, 0.034004, 0.038953, 0.028252, 0.017994
#*# 	-0.003623, -0.011954, -0.010776, -0.010758, -0.013880, -0.012860, -0.009096, -0.003755, 0.002354, 0.013789, 0.020142, 0.019074, 0.015249, 0.019214, 0.024653, 0.028826, 0.034340, 0.037050, 0.040534, 0.037572, 0.039008, 0.039083, 0.040813, 0.032922, 0.021790
#*# 	0.006497, 0.004097, 0.000659, -0.003840, -0.005090, -0.004331, -0.001917, 0.002997, 0.009370, 0.022996, 0.026389, 0.023240, 0.024653, 0.026194, 0.028551, 0.033017, 0.041718, 0.042587, 0.045597, 0.047994, 0.046401, 0.047127, 0.045599, 0.039187, 0.029089
#*# 	0.020192, 0.014928, 0.010530, 0.001022, 0.004374, 0.002450, 0.005508, 0.011935, 0.017897, 0.029332, 0.034603, 0.033123, 0.032655, 0.034180, 0.035696, 0.040732, 0.049553, 0.050659, 0.052522, 0.053153, 0.054273, 0.057292, 0.054602, 0.045979, 0.037134
#*# 	0.027120, 0.026347, 0.023074, 0.016019, 0.014466, 0.011848, 0.013911, 0.020986, 0.026558, 0.038326, 0.045625, 0.042892, 0.042506, 0.043931, 0.047737, 0.050472, 0.055817, 0.057623, 0.060067, 0.060465, 0.061591, 0.066123, 0.062862, 0.053615, 0.046146
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 270.0
#*# min_y = 30.0
#*# max_y = 270.0
#*#
#*# [probe]
#*# z_offset = -0.821
#*#
#*# [beacon model default]
#*# model_coef = 1.4651648776588897,
#*# 	1.7814820734920256,
#*# 	0.7649239974193266,
#*# 	0.3860679958165501,
#*# 	0.277491192083721,
#*# 	0.20428238489377565,
#*# 	-0.0544384750644775,
#*# 	-0.07091063363171587,
#*# 	0.14696269033581832,
#*# 	0.10132344645480006
#*# model_domain = 3.1843248785002355e-07,3.3403658574366056e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 48.384588
#*# model_offset = 0.01600
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 69.6
#*# shaper_type_y = zv
#*# shaper_freq_y = 46.0
