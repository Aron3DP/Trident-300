# THIS CONFIG IS FOR USE WITH Beacon & Mellow SB2040

# Required Configs, Always include these
[include mainsail.cfg]
[include macros/*.cfg]
[include scripts/*.cfg]

#####################################################################
#   MCU / Octopus v1.1 / SB2040
#####################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_25002D000150335331383520-if00
#serial: platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.3:1.0
restart_method: command

[mcu SB2040]
canbus_uuid: 1b89fd606a4c

[temperature_sensor Octopus]
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 0
max_temp: 100

[temperature_sensor SB2040]
sensor_type: temperature_mcu
sensor_mcu: SB2040
min_temp: 0
max_temp: 100

[temperature_sensor RPi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100


#####################################################################
#   Machine
#####################################################################

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 8000
max_z_velocity: 15
max_z_accel: 350
square_corner_velocity: 5.0

[idle_timeout]
timeout: 1800


#####################################################################
#   X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: SB2040:gpio29
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 75
homing_retract_dist: 5

[tmc2209 stepper_x]
uart_pin: PC4
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: PG9
position_min: 0
position_endstop: 307
position_max: 307
homing_speed: 75
homing_retract_dist: 5

[tmc2209 stepper_y]
uart_pin: PD11
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Z Stepper Settings
#####################################################################

[stepper_z]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_max: 290
position_min: -2.5
homing_speed: 10
second_homing_speed: 3
homing_retract_dist: 0


[tmc2209 stepper_z]
uart_pin: PC6
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z2]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Extruder / CW2
#####################################################################

[extruder]
step_pin: SB2040:gpio9
dir_pin: !SB2040:gpio10
enable_pin: !SB2040:gpio7
rotation_distance: 22.6789511
gear_ratio: 50:10
microsteps: 32
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: SB2040:gpio6
sensor_pin: SB2040:gpio27
sensor_type: ATC Semitec 104NT-4-R025H42G
min_temp: 10
max_temp: 315
max_extrude_only_distance: 500
max_extrude_cross_section: 5.0
max_power: 1.0
min_extrude_temp: 170
pressure_advance: 0.02
pressure_advance_smooth_time: 0.020

[tmc2209 extruder]
uart_pin: SB2040:gpio8
interpolate: false
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[firmware_retraction]
retract_length: 0.8
retract_speed: 30
unretract_extra_length: 0.0
unretract_speed: 30


#####################################################################
#   ADXL / Input Shaper
#####################################################################

[adxl345]
cs_pin: SB2040:gpio1
spi_software_sclk_pin: SB2040:gpio0
spi_software_mosi_pin: SB2040:gpio3
spi_software_miso_pin: SB2040:gpio2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345
probe_points: 150, 150, 20


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA2
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
max_power: 1
pwm_cycle_time: 0.0166
min_temp: 0
max_temp: 120


#####################################################################
#   Beacon
#####################################################################

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_8E79821B4E4B333448202020FF0A1818-if00
x_offset: 0
y_offset: 17.5
mesh_main_direction: x
mesh_runs: 2


#####################################################################
#   Bed Mesh
#####################################################################

[bed_mesh]
speed: 400
mesh_min: 30,30
mesh_max: 270,270
probe_count: 25,25
algorithm: bicubic


#####################################################################
#   Z-Tilt
#####################################################################

[z_tilt]
z_positions:
   -50, 18
   150, 348
   350, 18
points:
   30, 12.5
   150, 252.5
   270, 12.5
speed: 400
retries: 10
retry_tolerance: 0.004
horizontal_move_z: 10


#####################################################################
#   Safe Home
#####################################################################

[safe_z_home]
home_xy_position: 150,150
speed: 400
z_hop: 10


#####################################################################
#   Fan Control
#####################################################################

[fan]
pin: SB2040:gpio13
kick_start_time: 0.5
off_below: 0.10

[heater_fan hotend_fan]
pin: SB2040:gpio14
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[controller_fan Controller_Fan]
pin: PD12
kick_start_time: 0.5
heater: heater_bed
fan_speed: 0.50

[controller_fan SB2040_Fan]
pin: SB2040:gpio15
kick_start_time: 0.5
heater: heater_bed
fan_speed: 1.0


#####################################################################
# 	Chamber Thermistor
#####################################################################

[temperature_sensor Chamber]
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF5
min_temp: 0
max_temp: 100
gcode_id: chamber_th

[temperature_sensor Tool_Head]
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: SB2040:gpio26
min_temp: 0
max_temp: 100


#####################################################################
# EXP1 / EXP2 (display) pins
#####################################################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>


#####################################################################
#   Displays
#####################################################################

[display]
lcd_type: uc1701
cs_pin: EXP1_3
a0_pin: EXP1_4
rst_pin: EXP1_5
encoder_pins: ^EXP2_5, ^EXP2_3
click_pin: ^!EXP1_2
contrast: 63
spi_software_miso_pin: EXP2_1
spi_software_mosi_pin: EXP2_6
spi_software_sclk_pin: EXP2_2

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.865
#*# pid_ki = 4.335
#*# pid_kd = 58.553
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 65.636
#*# pid_ki = 4.376
#*# pid_kd = 246.136
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.062384, 0.068136, 0.072614, 0.073301, 0.065537, 0.069275, 0.067434, 0.071283, 0.071632, 0.076357, 0.071775, 0.064981, 0.069659, 0.074331, 0.081825, 0.088310, 0.086187, 0.089903, 0.097620, 0.097440, 0.099626, 0.087251, 0.082031, 0.069860, 0.065657
#*# 	  0.060030, 0.059809, 0.072939, 0.056239, 0.052983, 0.057401, 0.054076, 0.054934, 0.055452, 0.063069, 0.057648, 0.046267, 0.050820, 0.057145, 0.068384, 0.072749, 0.073676, 0.081592, 0.083350, 0.084321, 0.087183, 0.073697, 0.072307, 0.056928, 0.052416
#*# 	  0.054690, 0.047348, 0.061638, 0.051029, 0.042766, 0.040129, 0.035203, 0.036725, 0.043413, 0.054053, 0.051846, 0.037016, 0.033123, 0.034820, 0.043998, 0.061774, 0.069502, 0.071622, 0.071487, 0.068060, 0.067518, 0.057873, 0.059723, 0.048501, 0.037325
#*# 	  0.040742, 0.035236, 0.054739, 0.031076, 0.020272, 0.016358, 0.019344, 0.026852, 0.035056, 0.042775, 0.031335, 0.012839, 0.013500, 0.020863, 0.037359, 0.057609, 0.046980, 0.053357, 0.050615, 0.056171, 0.061619, 0.053745, 0.042402, 0.036444, 0.033302
#*# 	  0.024113, 0.022350, 0.043151, 0.021670, 0.012387, 0.006794, 0.000152, 0.003134, 0.019058, 0.029977, 0.020044, -0.002140, -0.007788, -0.002720, 0.023638, 0.044488, 0.040373, 0.043895, 0.040331, 0.038809, 0.043840, 0.040976, 0.034923, 0.028251, 0.018111
#*# 	  0.011767, 0.009694, 0.032720, 0.018457, 0.002931, -0.008085, -0.011290, -0.008371, 0.001847, 0.012049, 0.006129, -0.017714, -0.031158, -0.022073, 0.001719, 0.029635, 0.026945, 0.032304, 0.021536, 0.023154, 0.026548, 0.026727, 0.023963, 0.016486, 0.005240
#*# 	  -0.002180, -0.000373, 0.031061, 0.009144, -0.002145, -0.011919, -0.014570, -0.009759, -0.003965, 0.003580, -0.006586, -0.030024, -0.032304, -0.024953, -0.001184, 0.015922, 0.012602, 0.013774, 0.010587, 0.019659, 0.023828, 0.019951, 0.016302, 0.004851, -0.002312
#*# 	  -0.002656, -0.003646, 0.014757, 0.009261, 0.001698, -0.003314, -0.008399, -0.013457, -0.007135, 0.001202, -0.002333, -0.018867, -0.022490, -0.015440, -0.002848, 0.011515, 0.012006, 0.015947, 0.011345, 0.014467, 0.015128, 0.009748, 0.014691, 0.004237, -0.007518
#*# 	  -0.002909, -0.009308, 0.004314, 0.003362, 0.002022, -0.001303, -0.007818, -0.009140, -0.007308, 0.004204, 0.001421, -0.010362, -0.007574, -0.006811, -0.000687, 0.008270, 0.007111, 0.012951, 0.010802, 0.013646, 0.016424, 0.010578, 0.012501, 0.003451, -0.004760
#*# 	  -0.010348, -0.011998, -0.001533, -0.004363, -0.009117, -0.008680, -0.011400, -0.010902, -0.003512, -0.000796, -0.003514, -0.017422, -0.011326, -0.005554, 0.001190, 0.003414, -0.000547, 0.000399, -0.000027, 0.006788, 0.014030, 0.008584, -0.000451, -0.009345, -0.009060
#*# 	  -0.008919, -0.013380, -0.006719, -0.000704, -0.007253, -0.012316, -0.018758, -0.019577, -0.011394, 0.003731, -0.000829, -0.013677, -0.011897, -0.010818, -0.006657, 0.005237, 0.002455, 0.001536, -0.004284, -0.002747, 0.004887, -0.001052, -0.001227, -0.009692, -0.011508
#*# 	  -0.003148, -0.004248, 0.000082, 0.007101, -0.005623, -0.012565, -0.019018, -0.013175, -0.004659, 0.004998, 0.005359, -0.011699, -0.008290, -0.003785, 0.001835, 0.006993, 0.004172, -0.001855, -0.005202, -0.000362, 0.007697, 0.004701, -0.006422, -0.009416, 0.004642
#*# 	  0.009992, 0.008554, 0.012939, 0.014574, 0.004876, -0.000594, -0.005050, -0.000492, 0.003227, 0.013898, 0.011898, -0.001376, 0.000751, 0.008929, 0.011576, 0.017862, 0.009784, 0.003237, 0.002302, 0.003459, 0.017025, 0.008722, 0.000171, -0.004907, 0.010571
#*# 	  0.019453, 0.014250, 0.019757, 0.024059, 0.015578, 0.010179, -0.002871, -0.000539, 0.000889, 0.013965, 0.014816, 0.005708, 0.004231, 0.005914, 0.008762, 0.014638, 0.012229, 0.011024, 0.007126, 0.004389, 0.010786, 0.004537, 0.002525, -0.002540, 0.001476
#*# 	  0.021182, 0.017629, 0.020723, 0.020135, 0.009676, 0.005676, 0.000886, 0.002371, 0.004937, 0.008861, 0.010652, -0.003573, 0.005516, 0.005959, 0.007824, 0.009090, 0.005072, 0.001677, 0.002111, 0.005126, 0.008873, 0.001317, -0.005664, -0.009925, -0.008411
#*# 	  0.019490, 0.011792, 0.016528, 0.013339, 0.008087, 0.003901, -0.002239, -0.004603, -0.003550, 0.004199, 0.002590, -0.007349, -0.005361, -0.000160, -0.000710, 0.002833, -0.004059, -0.004509, -0.006281, -0.006956, 0.001493, -0.010521, -0.013865, -0.023224, -0.021687
#*# 	  0.019046, 0.011086, 0.013417, 0.014005, 0.003949, -0.000584, -0.008881, -0.010374, -0.004767, 0.001924, 0.001292, -0.012824, -0.009821, -0.009048, -0.008337, -0.004421, -0.005905, -0.007798, -0.013574, -0.013160, -0.008880, -0.017011, -0.021344, -0.029933, -0.037008
#*# 	  0.016508, 0.010579, 0.011880, 0.009093, 0.000978, -0.006127, -0.008458, -0.010390, -0.003713, 0.002197, -0.004680, -0.018355, -0.015912, -0.012127, -0.009602, -0.003512, -0.013044, -0.015294, -0.019096, -0.016501, -0.009235, -0.015408, -0.028010, -0.034744, -0.040530
#*# 	  0.018703, 0.010720, 0.010940, 0.012384, 0.005175, 0.000211, -0.006933, -0.009050, -0.004694, 0.000658, -0.003471, -0.015954, -0.016022, -0.015468, -0.011279, -0.006024, -0.010039, -0.013310, -0.019734, -0.016844, -0.012915, -0.019786, -0.027338, -0.035236, -0.044823
#*# 	  0.016223, 0.006395, 0.008807, 0.011973, 0.005508, -0.004415, -0.010599, -0.011589, -0.009789, -0.003493, -0.006902, -0.018858, -0.020739, -0.019048, -0.016857, -0.010631, -0.012981, -0.017164, -0.024762, -0.022802, -0.019680, -0.025895, -0.034220, -0.041586, -0.053114
#*# 	  0.017804, 0.009048, 0.011124, 0.011990, 0.004329, -0.000613, -0.007681, -0.011404, -0.010179, -0.005884, -0.009021, -0.023339, -0.022596, -0.021079, -0.019474, -0.015292, -0.018882, -0.020515, -0.026999, -0.027013, -0.022287, -0.032098, -0.038081, -0.048669, -0.060444
#*# 	  0.026010, 0.016208, 0.017460, 0.019952, 0.012498, 0.006881, -0.001112, -0.007252, -0.005371, -0.002508, -0.006694, -0.020917, -0.019588, -0.017554, -0.016724, -0.012476, -0.016813, -0.017167, -0.024347, -0.024786, -0.024076, -0.033063, -0.040314, -0.049814, -0.062511
#*# 	  0.036149, 0.027101, 0.030164, 0.031052, 0.022402, 0.014849, 0.005220, -0.001326, -0.000817, 0.001100, -0.003826, -0.016383, -0.015383, -0.011642, -0.011956, -0.008001, -0.010082, -0.013087, -0.019402, -0.022436, -0.020525, -0.031712, -0.037780, -0.047392, -0.058873
#*# 	  0.048436, 0.040233, 0.043531, 0.045757, 0.035685, 0.026555, 0.016150, 0.008443, 0.006870, 0.008380, 0.005695, -0.008724, -0.005629, -0.005205, -0.005731, -0.002675, -0.006268, -0.008838, -0.016021, -0.017119, -0.017258, -0.023976, -0.033519, -0.042599, -0.053242
#*# 	  0.069178, 0.063008, 0.067561, 0.065654, 0.054698, 0.045950, 0.034904, 0.027411, 0.026152, 0.027989, 0.025009, 0.009253, 0.012834, 0.011988, 0.006950, 0.007597, 0.003930, -0.000640, -0.007344, -0.008169, -0.006058, -0.013896, -0.023324, -0.033330, -0.043991
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 270.0
#*# min_y = 30.0
#*# max_y = 270.0
#*#
#*# [probe]
#*# z_offset = -0.821
#*#
#*# [beacon model default]
#*# model_coef = 1.4651648776588897,
#*# 	1.7814820734920256,
#*# 	0.7649239974193266,
#*# 	0.3860679958165501,
#*# 	0.277491192083721,
#*# 	0.20428238489377565,
#*# 	-0.0544384750644775,
#*# 	-0.07091063363171587,
#*# 	0.14696269033581832,
#*# 	0.10132344645480006
#*# model_domain = 3.1843248785002355e-07,3.3403658574366056e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 48.384588
#*# model_offset = -0.41500
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 67.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 45.6
