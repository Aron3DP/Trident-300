# THIS CONFIG IS FOR USE WITH Beacon & Mellow SB2040

# Required Configs, Always include these
[include mainsail.cfg]
[include macros/*.cfg]
[include scripts/*.cfg]

#####################################################################
#   MCU / Octopus v1.1 / SB2040
#####################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_25002D000150335331383520-if00
# serial: platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.3:1.0
restart_method: command

[mcu SB2040]
canbus_uuid: 1b89fd606a4c

[temperature_sensor Octopus]
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 0
max_temp: 100

[temperature_sensor SB2040]
sensor_type: temperature_mcu
sensor_mcu: SB2040
min_temp: 0
max_temp: 100

[temperature_sensor RPi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100


#####################################################################
#   Machine
#####################################################################

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 8000
max_z_velocity: 15
max_z_accel: 350
square_corner_velocity: 5.0

[idle_timeout]
timeout: 1800


#####################################################################
#   X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: SB2040:gpio29
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 75
homing_retract_dist: 5

[tmc2209 stepper_x]
uart_pin: PC4
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 400
endstop_pin: PG9
position_min: 0
position_endstop: 307
position_max: 307
homing_speed: 75
homing_retract_dist: 5

[tmc2209 stepper_y]
uart_pin: PD11
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Z Stepper Settings
#####################################################################

[stepper_z]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_max: 290
position_min: -2.5
homing_speed: 10
second_homing_speed: 3
homing_retract_dist: 0


[tmc2209 stepper_z]
uart_pin: PC6
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z2]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: 4
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Extruder / CW2
#####################################################################

[extruder]
step_pin: SB2040:gpio9
dir_pin: !SB2040:gpio10
enable_pin: !SB2040:gpio7
rotation_distance: 22.6789511
gear_ratio: 50:10
microsteps: 32
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: SB2040:gpio6
sensor_pin: SB2040:gpio27
sensor_type: ATC Semitec 104NT-4-R025H42G
min_temp: 10
max_temp: 315
max_extrude_only_distance: 500
max_extrude_cross_section: 5.0
max_power: 1.0
min_extrude_temp: 170
pressure_advance: 0.02
pressure_advance_smooth_time: 0.020

[tmc2209 extruder]
uart_pin: SB2040:gpio8
interpolate: false
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[firmware_retraction]
retract_length: 0.8
retract_speed: 30
unretract_extra_length: 0.0
unretract_speed: 30


#####################################################################
#   ADXL / Input Shaper
#####################################################################

[adxl345]
cs_pin: SB2040:gpio1
spi_software_sclk_pin: SB2040:gpio0
spi_software_mosi_pin: SB2040:gpio3
spi_software_miso_pin: SB2040:gpio2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345
probe_points: 150, 150, 20


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA2
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
max_power: 1
pwm_cycle_time: 0.0166
min_temp: 0
max_temp: 120


#####################################################################
#   Beacon
#####################################################################

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_8E79821B4E4B333448202020FF0A1818-if00
x_offset: 0
y_offset: 17.5
mesh_main_direction: x
mesh_runs: 2


#####################################################################
#   Bed Mesh
#####################################################################

[bed_mesh]
speed: 400
mesh_min: 30,30
mesh_max: 270,270
probe_count: 25,25
algorithm: bicubic


#####################################################################
#   Z-Tilt
#####################################################################

[z_tilt]
z_positions:
   -50, 18
   150, 348
   350, 18
points:
   30, 12.5
   150, 270
   270, 12.5
speed: 400
retries: 10
retry_tolerance: 0.0075
horizontal_move_z: 10


#####################################################################
#   Safe Home
#####################################################################

[safe_z_home]
home_xy_position: 150,150
speed: 400
z_hop: 10


#####################################################################
#   Fan Control
#####################################################################

[fan]
pin: SB2040:gpio13
kick_start_time: 0.5
off_below: 0.10

[heater_fan hotend_fan]
pin: SB2040:gpio14
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[controller_fan Controller_Fan]
pin: PD12
kick_start_time: 0.5
heater: heater_bed
fan_speed: 0.50

[controller_fan SB2040_Fan]
pin: SB2040:gpio15
kick_start_time: 0.5
heater: heater_bed
fan_speed: 1.0


#####################################################################
# 	Chamber Thermistor
#####################################################################

[temperature_sensor Chamber]
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF5
min_temp: 0
max_temp: 100
gcode_id: chamber_th

[temperature_sensor Tool_Head]
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: SB2040:gpio26
min_temp: 0
max_temp: 100


#####################################################################
# EXP1 / EXP2 (display) pins
#####################################################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>


#####################################################################
#   Displays
#####################################################################

[display]
lcd_type: uc1701
cs_pin: EXP1_3
a0_pin: EXP1_4
rst_pin: EXP1_5
encoder_pins: ^EXP2_5, ^EXP2_3
click_pin: ^!EXP1_2
contrast: 63
spi_software_miso_pin: EXP2_1
spi_software_mosi_pin: EXP2_6
spi_software_sclk_pin: EXP2_2

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.865
#*# pid_ki = 4.335
#*# pid_kd = 58.553
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 65.636
#*# pid_ki = 4.376
#*# pid_kd = 246.136
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.019286, 0.020191, 0.021054, 0.012903, 0.006576, 0.004345, 0.009231, 0.004339, 0.012699, 0.019870, 0.029867, 0.023497, 0.023337, 0.027097, 0.021132, 0.033575, 0.045324, 0.046684, 0.038745, 0.037280, 0.029900, 0.037859, 0.038621, 0.039347, 0.029360
#*# 	  0.018480, 0.010718, 0.010694, 0.000520, -0.004895, 0.003143, 0.001461, -0.004685, -0.002463, 0.013765, 0.017442, 0.023171, 0.014280, 0.014713, 0.012516, 0.023116, 0.028204, 0.028466, 0.034812, 0.027109, 0.019690, 0.020289, 0.028000, 0.024381, 0.016416
#*# 	  0.006582, 0.004503, 0.001834, -0.008038, -0.015692, -0.013857, -0.014066, -0.008914, -0.005441, 0.008628, 0.009236, 0.005836, -0.000807, -0.001999, 0.005363, 0.016932, 0.023218, 0.018050, 0.018079, 0.011004, 0.011152, 0.012403, 0.017252, 0.011143, 0.001711
#*# 	  -0.005398, -0.004872, -0.013425, -0.020067, -0.025341, -0.023414, -0.014872, -0.016894, -0.018816, -0.010078, -0.000669, -0.004670, -0.001215, -0.007850, -0.005711, -0.001631, 0.005200, 0.007722, 0.007526, 0.009441, 0.002124, 0.000295, 0.000175, -0.003184, -0.004018
#*# 	  -0.017526, -0.015412, -0.020550, -0.032429, -0.033490, -0.034196, -0.030141, -0.024846, -0.020146, -0.016845, -0.013041, -0.016390, -0.019444, -0.016752, -0.012177, -0.005601, -0.003170, -0.002199, -0.003345, -0.003563, -0.004126, -0.003673, -0.006751, -0.012946, -0.017419
#*# 	  -0.026145, -0.022761, -0.031114, -0.041974, -0.040581, -0.038460, -0.036645, -0.029934, -0.032147, -0.027013, -0.025403, -0.024747, -0.025935, -0.020325, -0.021398, -0.016364, -0.015080, -0.010140, -0.010056, -0.012548, -0.007790, -0.011795, -0.013190, -0.022768, -0.028883
#*# 	  -0.031171, -0.028613, -0.034503, -0.042610, -0.043597, -0.040423, -0.037312, -0.034033, -0.038760, -0.032324, -0.028912, -0.029387, -0.031023, -0.026577, -0.026580, -0.020879, -0.017416, -0.016484, -0.012855, -0.017339, -0.014206, -0.017488, -0.019349, -0.027211, -0.034012
#*# 	  -0.025396, -0.025064, -0.026835, -0.039936, -0.042079, -0.037441, -0.033426, -0.032659, -0.032648, -0.030856, -0.024861, -0.028713, -0.028196, -0.026129, -0.022996, -0.018093, -0.016042, -0.014240, -0.011059, -0.014941, -0.016072, -0.014413, -0.018282, -0.025781, -0.034188
#*# 	  -0.017897, -0.020107, -0.023397, -0.035166, -0.033598, -0.032199, -0.027942, -0.028140, -0.033258, -0.028461, -0.023814, -0.022037, -0.021315, -0.021273, -0.019690, -0.018131, -0.014779, -0.010310, -0.008976, -0.013772, -0.012711, -0.012779, -0.014360, -0.022321, -0.031544
#*# 	  -0.018786, -0.020597, -0.025484, -0.033827, -0.036531, -0.039347, -0.034211, -0.033795, -0.038029, -0.028215, -0.021178, -0.022605, -0.026703, -0.021801, -0.022526, -0.017967, -0.016120, -0.015188, -0.016098, -0.016595, -0.014863, -0.014145, -0.017313, -0.026828, -0.035952
#*# 	  -0.010592, -0.016663, -0.022155, -0.032147, -0.035883, -0.032885, -0.033386, -0.033508, -0.036662, -0.029361, -0.018275, -0.020924, -0.022288, -0.021618, -0.022114, -0.020764, -0.017080, -0.016305, -0.014412, -0.017959, -0.015959, -0.015654, -0.018926, -0.030064, -0.039279
#*# 	  -0.000292, -0.006244, -0.013211, -0.022209, -0.028780, -0.025015, -0.028396, -0.028187, -0.028193, -0.017212, -0.007318, -0.010813, -0.014453, -0.017650, -0.015250, -0.012090, -0.011450, -0.008686, -0.008411, -0.013334, -0.011751, -0.010276, -0.013659, -0.024475, -0.035241
#*# 	  0.018004, 0.008285, 0.003023, -0.008257, -0.013909, -0.013132, -0.013182, -0.012908, -0.011746, -0.004182, 0.006760, 0.001548, -0.001561, -0.000782, -0.003436, -0.000584, 0.001622, 0.000945, 0.004127, -0.000476, -0.002710, -0.002062, -0.005947, -0.016908, -0.027644
#*# 	  0.022619, 0.016553, 0.011842, 0.000626, -0.004647, -0.004300, -0.005109, -0.002803, -0.002299, 0.004548, 0.012031, 0.010352, 0.004873, 0.006504, 0.004642, 0.004897, 0.006309, 0.007386, 0.008335, 0.003985, 0.001475, 0.002800, -0.001466, -0.012656, -0.022556
#*# 	  0.027307, 0.018503, 0.015457, 0.003039, -0.002456, -0.005002, -0.003227, 0.001192, 0.002402, 0.003919, 0.012721, 0.010830, 0.004971, 0.007463, 0.008084, 0.006662, 0.007724, 0.007480, 0.005590, 0.001705, -0.000593, -0.000074, -0.005174, -0.014036, -0.026942
#*# 	  0.026921, 0.017517, 0.010520, -0.000073, -0.005788, -0.008199, -0.004951, -0.000893, -0.003521, 0.001979, 0.008351, 0.005772, 0.004014, 0.004831, 0.003033, 0.000483, 0.003965, 0.003759, 0.002406, -0.002575, -0.006412, -0.008647, -0.012438, -0.022848, -0.032629
#*# 	  0.025295, 0.016099, 0.011432, -0.001026, -0.009549, -0.009453, -0.007883, -0.005520, -0.003260, 0.001147, 0.006216, 0.001722, 0.000788, 0.001096, -0.001460, -0.003019, -0.000826, 0.000361, -0.000647, -0.006463, -0.010069, -0.014432, -0.018831, -0.030151, -0.042108
#*# 	  0.028167, 0.017961, 0.010800, 0.000882, -0.006204, -0.007431, -0.005119, -0.002209, -0.003909, 0.004222, 0.005452, 0.002714, 0.000818, 0.000923, -0.002661, -0.003902, 0.000246, -0.000557, 0.000330, -0.005874, -0.010962, -0.014827, -0.022924, -0.035960, -0.045646
#*# 	  0.032693, 0.022825, 0.018176, 0.006404, 0.003183, 0.000621, 0.000602, 0.001191, 0.003657, 0.009307, 0.012116, 0.007706, 0.006844, 0.004357, -0.000159, 0.000344, 0.002696, 0.001226, -0.000834, -0.005920, -0.010903, -0.014998, -0.021096, -0.033570, -0.046304
#*# 	  0.036619, 0.029404, 0.022555, 0.012413, 0.005456, 0.004865, 0.003306, 0.004047, 0.005199, 0.010223, 0.010437, 0.009010, 0.003889, 0.002114, -0.001710, -0.000998, 0.001160, -0.003035, -0.003669, -0.009066, -0.015662, -0.019468, -0.024024, -0.038779, -0.050360
#*# 	  0.039760, 0.029087, 0.024005, 0.012399, 0.007501, 0.003830, 0.004177, 0.003522, 0.003263, 0.008671, 0.009985, 0.006345, -0.000579, -0.004729, -0.004992, -0.005285, -0.004548, -0.006712, -0.010659, -0.015020, -0.022103, -0.028220, -0.030326, -0.045397, -0.059006
#*# 	  0.047739, 0.037701, 0.031016, 0.021639, 0.013842, 0.008071, 0.006426, 0.007875, 0.007624, 0.013869, 0.012824, 0.006964, -0.002128, -0.004145, -0.007186, -0.003446, -0.005559, -0.007836, -0.009611, -0.013985, -0.021877, -0.026257, -0.030664, -0.045282, -0.059044
#*# 	  0.062119, 0.048191, 0.040453, 0.028574, 0.022255, 0.016295, 0.014358, 0.013575, 0.014753, 0.019016, 0.016742, 0.010329, 0.004404, 0.000441, -0.002596, -0.001700, -0.001436, -0.003549, -0.007824, -0.012604, -0.019158, -0.023818, -0.029800, -0.043259, -0.058533
#*# 	  0.071232, 0.061988, 0.051025, 0.040676, 0.032109, 0.025351, 0.021250, 0.021780, 0.020385, 0.025769, 0.026910, 0.017018, 0.011552, 0.005481, 0.002257, 0.001307, 0.003488, -0.000962, -0.004817, -0.011207, -0.017315, -0.018139, -0.028385, -0.040570, -0.055131
#*# 	  0.084846, 0.072483, 0.066261, 0.049092, 0.041449, 0.035246, 0.029051, 0.030195, 0.029328, 0.033362, 0.034165, 0.025569, 0.018291, 0.014388, 0.011652, 0.007047, 0.007140, 0.003837, -0.002044, -0.006625, -0.012097, -0.014256, -0.024182, -0.039179, -0.053489
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 270.0
#*# min_y = 30.0
#*# max_y = 270.0
#*#
#*# [probe]
#*# z_offset = -0.821
#*#
#*# [beacon model default]
#*# model_coef = 1.4651648776588897,
#*# 	  1.7814820734920256,
#*# 	  0.7649239974193266,
#*# 	  0.3860679958165501,
#*# 	  0.277491192083721,
#*# 	  0.20428238489377565,
#*# 	  -0.0544384750644775,
#*# 	  -0.07091063363171587,
#*# 	  0.14696269033581832,
#*# 	  0.10132344645480006
#*# model_domain = 3.1843248785002355e-07,3.3403658574366056e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 48.384588
#*# model_offset = -0.38200
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 70.4
#*# shaper_type_y = zv
#*# shaper_freq_y = 46.4
